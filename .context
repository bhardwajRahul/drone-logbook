{
  "project": {
    "name": "DJI Logbook",
    "goal": "Local-first DJI logbook with charts, maps, and analytics. Available as a Tauri v2 desktop app or a Docker-deployable web app.",
    "stack": {
      "desktop": "Tauri v2 (feature: tauri-app)",
      "web": "Axum 0.7 + Nginx (feature: web)",
      "frontend": "React 18 + TypeScript + Vite + Tailwind",
      "state": "Zustand",
      "charts": "ECharts (echarts-for-react)",
      "maps": "MapLibre GL (react-map-gl) + deck.gl",
      "database": "DuckDB (duckdb-rs, bundled)",
      "parser": "dji-log-parser v0.5.7"
    },
    "os": "Linux",
    "runtime": {
      "node": "18.x",
      "rust": "stable (1.85+ required by DuckDB)",
      "tauri_cli": "2.x"
    }
  },
  "dependencies": {
    "frontend": {
      "react": "^18.3.1",
      "react_dom": "^18.3.1",
      "vite": "^6.0.0",
      "tailwindcss": "^3.4.14",
      "zustand": "^5.0.0",
      "echarts": "^5.5.0",
      "echarts_for_react": "^3.0.2",
      "react_map_gl": "^7.1.7",
      "maplibre_gl": "^4.7.0",
      "deck_gl": "^9.x",
      "deck_gl_layers": "^9.x",
      "react_dropzone": "^14.3.5",
      "react_day_picker": "^9.13.0"
    },
    "tauri_plugins": [
      "@tauri-apps/api",
      "@tauri-apps/plugin-dialog",
      "@tauri-apps/plugin-fs",
      "@tauri-apps/plugin-log",
      "@tauri-apps/plugin-shell"
    ],
    "backend": {
      "duckdb_rs": "bundled",
      "dji_log_parser": "0.5.7",
      "axum": "0.7 (web feature, with multipart)",
      "tower_http": "0.5 (web feature, with cors + fs)",
      "env_logger": "0.11",
      "flate2": "1 (gzip compression for backup archives)",
      "tar": "0.4 (tar archive for backup/restore)",
      "reverse_geocoder": "4.1.1 (offline city/country/continent geocoding from GeoNames data)",
      "tempfile": "3 (dev-dependency for tests)"
    }
  },
  "build_modes": {
    "tauri_app": {
      "description": "Desktop app with Tauri v2 IPC (default feature)",
      "cargo_features": "tauri-app (default)",
      "frontend_env": "VITE_BACKEND unset or != 'web'",
      "commands": {
        "dev": "npm run tauri",
        "build": "npm run tauri build"
      }
    },
    "web": {
      "description": "REST API server with Axum for Docker/web deployment",
      "cargo_features": "web (--no-default-features --features web)",
      "frontend_env": "VITE_BACKEND=web",
      "commands": {
        "dev_frontend": "npm run dev:web",
        "dev_backend": "cargo run --features web --no-default-features",
        "build_frontend": "npm run build:web",
        "build_backend": "cargo build --release --features web --no-default-features",
        "docker": "docker compose up --build"
      }
    }
  },
  "scope": {
    "features": [
      "Import and parse DJI flight logs (bulk import with cooldown).",
      "Local DuckDB storage with telemetry schema, WAL recovery, and migration support.",
      "Overview analytics page (totals, averages, max altitude, max distance from home).",
      "Overview activity heatmap (365-day, 7x52 grid) with date range selector.",
      "Overview donut charts for flights by drone model, batteries used, and flight duration (short/mid/long).",
      "Overview top 3 longest and furthest (distance-from-home) flights.",
      "Overview map area filter: toggle in sidebar filters flights to only those visible on the overview map. Map shows green glow border and 'Global filter active' title when enabled. Reset zoom button fits all flights.",
      "Battery health: per-serial health bars, inline rename (pencil icon, uniqueness-validated, persisted to localStorage), and per-minute usage history plot (scatter + smoothed line) with zoom slider and drag-to-zoom.",
      "Flight list with rename (pencil icon), delete (trash icon), filters (date range, drone, battery, duration range slider, map area), search, and sorting.",
      "Flight list sidebar: collapsible Filters section (default collapsed) and Import section (auto-collapsed when flights exist, auto-expanded when empty).",
      "Overview uses sidebar-filtered flights via Zustand store (sidebarFilteredFlightIds) instead of its own filter bar.",
      "Settings: API key, units (metric/imperial), theme (light/dark/system), delete-all logs.",
      "Settings: shows app data + log directory for troubleshooting.",
      "Charts: height/VPS/speed (metric in km/h), battery, attitude, RC signal, GPS satellites.",
      "Charts: RC uplink/downlink, distance-to-home, and velocity XYZ panels.",
      "Charts: synchronized zoom, drag-to-zoom toggle, reset zoom, auto-scaled Y axes, aligned X-axis ticks, custom tooltip header with pills.",
      "Map: 3D terrain view via MapLibre, global theme styling.",
      "Map: satellite style toggle, gradient flight path with start/end markers.",
      "Map: deck.gl 3D path overlay; map toggles persist in session.",
      "Map: Catmull-Rom spline smoothing, color-by modes (progress/height/speed/distance), hover tooltip.",
      "Map: Flight replay with play/pause, seek slider, speed selector (0.5x-16x), and 3D-aware aircraft marker.",
      "Map: Replay telemetry overlay (top-right) showing live-interpolated height, speed, distance, battery, satellites, attitude, and coordinates synced to playback position. RC stick input overlay above playbar with progressive-fill bar indicators for throttle, rudder, elevator, and aileron — theme-aware with visible track rails. Hover tooltip paused during replay.",
      "Map: Aircraft toggle to show/hide replay controls and marker. Satellite maxzoom 18, terrain DEM maxzoom 12.",
      "Export: CSV/JSON/GPX/KML downloads from flight stats.",
      "Logging: comprehensive debug logging via tauri-plugin-log (desktop) or env_logger (web).",
      "Crash protection: parser uses spawn_blocking + catch_unwind + timeout. Telemetry validated for GPS range, finite values, altitude/speed sanity.",
      "UI polish: theme variables, tag styling for device/serials, modal scrollbar lock.",
      "UI polish: Import progress counter showing current file out of total during batch imports.",
      "UI polish: Sidebar width remembered across sessions via localStorage.",
      "UI polish: Layout clipping fixes for Tauri on Linux (100vh -> 100% for title bar area).",
      "UI polish: Battery serial rename mapping (frontend-only, persisted to localStorage, shown everywhere).",
      "UI polish: Horizontal scrollbar on Overview (min-w-[1100px]) and Flights detail view (min-w-[1100px]) when window is narrower than content.",
      "UI polish: WeatherModal rendered via createPortal to document.body with modal-open class for scrollbar suppression.",
      "Smart Tags: Auto-generated descriptive tags on import (Night Flight, High Speed, Cold Battery, Heavy Load, Low Battery, High Altitude, Long Distance, Long Flight, Short Flight, Aggressive Flying, No GPS) plus offline reverse geocoding (city, country, continent) via reverse_geocoder crate.",
      "Smart Tags: Two tag types — auto (teal capsules) and manual (violet capsules). Add/remove manual tags via FlightStats. Settings toggle to enable/disable auto-tagging on import. Regenerate smart tags for all flights button in Settings.",
      "Smart Tags: flight_tags table in DuckDB with tag_type column (auto/manual), migration for older DBs, included in backup/restore.",
      "Flight list: Tag filter (multi-select dropdown with checkboxes). Filter inversion button (circular arrows icon) to negate all active filters.",
      "Flight list: Keyboard navigation — Up/Down arrows to browse flights (preview highlight), Enter to select and load. Selection auto-clears when filtered out.",
      "UI: Select dropdowns (drone, battery, settings) are searchable — type to filter options, arrow keys to navigate, Enter selects, Escape closes.",
      "UI: All dropdowns (sort, export, tag filter) support arrow key navigation with visual highlight.",
      "UI: Escape key closes modals (Settings, Weather).",
      "Backup & Restore: Export full database (flights, telemetry, keychains, flight_tags) to a portable gzip-compressed tar archive of Parquet files. Import restores data with upsert semantics. Works in both Tauri (native save/open dialogs) and web (browser download/upload).",
      "Data safety: DB backup, corruption handling, telemetry rebuild when column order mismatches.",
      "Docker/Web deployment: Axum REST API mirroring all Tauri commands, Nginx reverse proxy, multi-stage Docker build.",
      "Dual-mode frontend: api.ts adapter uses invoke() for Tauri, fetch() for web. All @tauri-apps imports are dynamic.",
      "Supporter Badge: SHA-256 verified activation code system. Badge displayed in sidebar header between app title and settings icon. Activation modal in settings with Ko-fi donation instructions. Badge persisted to localStorage. Donation toggle locked when badge active. CSS animations (fadeIn, starPulse) with light mode overrides.",
      "Settings modal: Two-column layout (max-w-3xl). Left column: Units, Theme, Smart Tags, API Key. Right column: Donation status, Supporter Badge, App info, Backup/Restore, Delete all logs.",
      "App version: Displayed in settings. Reads from Tauri API (desktop) or Vite-injected __APP_VERSION__ (web). vite.config.ts reads version from src-tauri/tauri.conf.json with existsSync fallback to package.json for Docker builds.",
      "Filter inversion: Uses AND logic for inverted filters (NOT A AND NOT B) — each filter condition individually inverted rather than inverting the combined result."
    ],
    "out_of_scope": [
      "Cloud sync",
      "External analytics pipelines"
    ]
  },
  "structure": {
    "frontend": {
      "root": "src",
      "key_components": [
        "src/components/dashboard/Dashboard.tsx",
        "src/components/dashboard/FlightList.tsx",
        "src/components/dashboard/FlightStats.tsx",
        "src/components/dashboard/FlightImporter.tsx",
        "src/components/dashboard/SettingsModal.tsx",
        "src/components/dashboard/WeatherModal.tsx",
        "src/components/dashboard/Overview.tsx",
        "src/components/ui/Select.tsx",
        "src/components/charts/TelemetryCharts.tsx",
        "src/components/map/FlightMap.tsx"
      ],
      "styles": [
        "src/index.css",
        "tailwind.config.js"
      ],
      "state_store": "src/stores/flightStore.ts (includes batteryNameMap persisted to localStorage, sidebarFilteredFlightIds for Overview filter sync, allTags, smartTagsEnabled, isRegenerating, addTag/removeTag/regenerateSmartTags actions, supporterBadgeActive persisted to localStorage, setSupporterBadge action)",
      "api_adapter": "src/lib/api.ts",
      "types": "src/types/index.ts",
      "env_types": "src/vite-env.d.ts"
    },
    "backend": {
      "root": "src-tauri/src",
      "key_files": [
        "src-tauri/src/main.rs",
        "src-tauri/src/server.rs",
        "src-tauri/src/database.rs",
        "src-tauri/src/parser.rs",
        "src-tauri/src/models.rs",
        "src-tauri/src/api.rs",
        "src-tauri/src/lib.rs"
      ]
    },
    "docker": {
      "dockerfile": "Dockerfile",
      "compose": "docker-compose.yml (pre-built GHCR image)",
      "compose_build": "docker-compose-build.yml (build from source)",
      "nginx_conf": "docker/nginx.conf",
      "entrypoint": "docker/entrypoint.sh"
    },
    "ci": {
      "tauri_build": ".github/workflows/build.yml",
      "docker_build": ".github/workflows/docker.yml"
    },
    "config": {
      "env": ".env (DJI API key via env var)",
      "local_config": "config.json (API key stored locally)",
      "context_file": ".context (machine-readable project context, gitignored)"
    }
  },
  "data_flow": {
    "import_tauri": [
      "User selects file(s) via native dialog",
      "Tauri command parses using dji-log-parser (spawn_blocking + catch_unwind + 40s timeout)",
      "Parser validates telemetry: skips corrupt frames, filters GPS (lat +/-90, lon +/-180), clamps altitude (<10km) and speed (<100 m/s)",
      "Metadata inserted into flights table",
      "Telemetry bulk inserted with DuckDB Appender (column order enforced)",
      "If telemetry insert fails, flight metadata is cleaned up automatically",
      "UI refreshes flight list and telemetry views"
    ],
    "import_web": [
      "User selects file(s) via HTML file input or drag-and-drop",
      "File uploaded via multipart/form-data to POST /api/import",
      "Axum handler writes to temp file, parser processes identically to Tauri mode",
      "Temp file cleaned up after parsing",
      "JSON response returned with ImportResult"
    ],
    "telemetry_query": [
      "UI requests telemetry for flight via selectFlight()",
      "Store checks if same flight already selected (skip if so)",
      "Store checks _flightDataCache Map (LRU, max 10 entries) for instant hit",
      "On cache miss: api.getFlightData() routes to invoke() or fetch() based on mode",
      "Backend uses get_flight_by_id() for O(1) lookup",
      "Telemetry queries skip COUNT(*) when point_count known from flight metadata",
      "DB returns raw data or downsampled to ~5000 points (1s buckets)",
      "Response cached in frontend store for future re-selection",
      "Frontend converts units and renders charts/maps"
    ]
  },
  "recent_changes": {
    "docker_web_mode": {
      "description": "Added Docker/web deployment mode using Cargo feature flags.",
      "server": "src-tauri/src/server.rs - Axum REST API with all 11 endpoints mirroring Tauri commands. DefaultBodyLimit set to 250MB for large flight log uploads.",
      "api_adapter": "src/lib/api.ts - unified interface: invoke() for Tauri, fetch() for web. Lazy-loads @tauri-apps imports.",
      "feature_flags": "Cargo.toml: tauri-app (default) and web features. All Tauri deps are optional.",
      "main_rs": "Feature-gated: mod tauri_app for desktop, run_web() for Axum server.",
      "frontend_components": "FlightImporter, FlightList, FlightStats, SettingsModal updated with isWebMode() guards and dynamic imports.",
      "vite_config": "Web mode: /api proxy, conditional optimizeDeps, es2022 build target.",
      "docker": "Multi-stage Dockerfile (rust:1.85 -> node:20 -> nginx:stable), docker-compose.yml (GHCR image), docker-compose-build.yml (local build), nginx.conf, entrypoint.sh.",
      "npm_scripts": "Added dev:web and build:web scripts with VITE_BACKEND=web."
    },
    "backup_restore": {
      "description": "Full database backup and restore. Export creates a gzip-compressed tar archive containing Parquet files for flights, telemetry, and keychains tables. Import extracts and upserts data using delete-then-insert for flights (dual unique constraints: id + file_hash) and telemetry, INSERT OR REPLACE for keychains.",
      "backend": "database.rs: export_backup() and import_backup() methods. main.rs: export_backup and import_backup Tauri commands. server.rs: GET /api/backup and POST /api/backup/restore endpoints.",
      "frontend": "api.ts: backupDatabase() and restoreDatabase() with dual-mode support. SettingsModal.tsx: Backup/Restore buttons with loading overlay, spinner, and auto-dismiss messages.",
      "dependencies": "Added flate2 (gzip) and tar (archive) crates to Cargo.toml."
    },
    "dead_code_cleanup": {
      "description": "Removed unused DatabaseError variants (AppDataDirNotFound, NotInitialized) and methods (keychains_dir, get_flight_track, store_keychain, get_keychain) to eliminate compiler warnings."
    },
    "v1_4_0_ui_improvements": {
      "description": "Flight replay system, map fixes, layout fixes, chart zoom improvements, import counter, sidebar persistence.",
      "flight_replay": "FlightMap.tsx: play/pause, seek slider, speed selector (0.5x-16x), 3D-aware DeckGL ScatterplotLayer marker with altitude support.",
      "aircraft_toggle": "FlightMap.tsx: Aircraft toggle in map controls to show/hide replay controls and marker.",
      "sky_layer_fix": "FlightMap.tsx: Removed MapLibre-incompatible sky layer (Mapbox-only) from enableTerrain() that was crashing onLoad.",
      "map_zoom_fix": "FlightMap.tsx: Map maxZoom=22, satellite source maxzoom=18, terrain DEM maxzoom=12 (corrected from actual TileJSON).",
      "layout_clipping": "Dashboard.tsx h-screen to h-full, min-h-0 throughout flex chain. App.tsx flex-col overflow-hidden. index.html 100vh to 100%.",
      "import_counter": "FlightImporter.tsx: Shows 'X of Y files' during batch imports.",
      "sidebar_persistence": "Dashboard.tsx: Sidebar width saved to localStorage and restored on load.",
      "replay_slider_styles": "index.css: Custom slider thumb styles for the flight replay seek bar."
    },
    "smart_tags_and_ux": {
      "description": "Smart flight tagging system with offline reverse geocoding, searchable filter dropdowns, and filter inversion.",
      "smart_tags": "parser.rs: generate_smart_tags() produces auto tags based on flight stats (night, speed, battery, altitude, distance, duration). reverse_geocode() uses reverse_geocoder crate for offline city/country/continent from takeoff coordinates.",
      "tag_types": "Two types: auto (teal capsules, generated on import) and manual (violet capsules, user-added). FlightTag struct with tag + tag_type fields.",
      "tag_management": "database.rs: flight_tags table with tag_type column, CRUD methods (insert_flight_tags, add_flight_tag, remove_flight_tag, replace_auto_tags, get_all_unique_tags). Migration adds tag_type column to older DBs.",
      "tag_ui": "FlightStats.tsx: tag capsules with hover-to-delete, inline add-tag input with autocomplete suggestions. FlightList.tsx: multi-select tag filter with checkboxes. SettingsModal.tsx: smart tags toggle and regenerate button.",
      "filter_inversion": "FlightList.tsx: Invert button (circular arrows icon) negates all active filters. Red styling when inverted.",
      "searchable_selects": "Select.tsx: Type-to-filter search input at top of dropdown, Enter selects first match, text discarded on close/blur.",
      "settings_text": "SettingsModal.tsx: Simplified API key section text, links to GitHub guide.",
      "cfg_gate_fix": "main.rs: mod server and run_web() gated with cfg(all(feature = web, not(feature = tauri-app))) to eliminate 32 dead_code warnings.",
      "backup_tags": "database.rs: flight_tags table included in backup export and restore.",
      "api_endpoints": "server.rs: POST /api/flights/tags/add, POST /api/flights/tags/remove, GET /api/tags, GET/POST /api/settings/smart_tags, POST /api/regenerate_smart_tags.",
      "tauri_commands": "main.rs: add_flight_tag, remove_flight_tag, get_all_tags, get_smart_tags_enabled, set_smart_tags_enabled, regenerate_all_smart_tags."
    },
    "v2_1_0_supporter_badge_and_polish": {
      "description": "Supporter badge system, settings modal redesign, horizontal scrollbar fix, filter inversion logic fix, app version display, Docker build fix.",
      "supporter_badge": "flightStore.ts: supporterBadgeActive state persisted to localStorage, setSupporterBadge action. Dashboard.tsx: Badge in sidebar header between title and settings icon (amber gradient, star with pulse animation). SettingsModal.tsx: SHA-256 code verification via Web Crypto API, activation modal with Ko-fi instructions, manage/remove badge flow. Donation toggle locked when badge active. index.css: badgeFadeIn and starPulse animations with light mode overrides.",
      "settings_two_column": "SettingsModal.tsx: Widened from max-w-md to max-w-3xl. Content uses flex layout with vertical divider (w-px bg-gray-700). Left: Units, Theme, Smart Tags, API Key. Right: Donation, Supporter Badge, Info, Backup/Restore, Delete.",
      "horizontal_scrollbar": "App.tsx: Removed minWidth:1600, changed to overflow-hidden. Dashboard.tsx: Overview and Flights detail views wrapped in overflow-auto containers with min-w-[1100px] inner content for horizontal scrollbar.",
      "filter_inversion_fix": "FlightList.tsx: Changed from NOT(A AND B) to (NOT A AND NOT B) — each filter individually inverted for correct AND semantics.",
      "app_version": "SettingsModal.tsx: fetchAppVersion() tries Tauri getVersion() then falls back to __APP_VERSION__. vite.config.ts: reads version from tauri.conf.json with existsSync fallback to package.json for Docker.",
      "docker_build_fix": "vite.config.ts: Uses existsSync check for src-tauri/tauri.conf.json, falls back to package.json version. Prevents build failure in Docker frontend stage where src-tauri is absent."
    },
    "rc_stick_overlay_redesign": {
      "description": "Redesigned the RC stick input overlay on the flight map replay: removed all text labels, switched from filled arrow shapes to progressive-fill bar indicators with visible track rails, theme-aware colors via CSS custom properties.",
      "component": "FlightMap.tsx: StickArrows component uses VBar/HBar sub-components with background track (.stick-bar-track) and foreground fill that grows from center outward proportional to stick input (0-100%). Center dot retained. No text labels (removed L/R headers, Up/Down/Fwd/Back/CCW/CW labels).",
      "layout": "RC stick overlay and playbar wrapped in a shared flex-col container (items-stretch) so both share the exact same width. Left and right stick controls placed on opposite ends via justify-between. Gap (gap-1.5) separates overlay from playbar.",
      "theming": "index.css: CSS custom properties for bar fill colors — dark mode uses vivid cyan (--stick-bar-active: rgba(56,200,255,0.95)), light mode uses dark slate (--stick-bar-active: rgba(30,41,59,0.9)) for visibility on white backgrounds. Track rails always visible via --stick-track. Semi-transparent backdrop-blur background (--stick-bg: 38% dark / 42% light opacity).",
      "sizing": "Grid: 56x60px per stick. Bar length: 21px max. Bar thickness: 4px. Overlay padding: px-5 py-3."
    },
    "update_check_badge": {
      "description": "Automatic version check against GitHub releases on app start. Shows a capsule badge next to the version number in Settings.",
      "store": "flightStore.ts: Added updateStatus ('idle'|'checking'|'latest'|'outdated'|'failed') and latestVersion state. checkForUpdates() action fetches latest release tag from GitHub API (api.github.com/repos/arpanghosh8453/dji-logbook/releases/latest), compares with current app version (Tauri getVersion() or __APP_VERSION__ fallback).",
      "ui": "SettingsModal.tsx: Capsule badge next to App Version — green 'Latest' (emerald) when up-to-date, amber 'Update to vX.X.X' when outdated (links to release page), red 'Check failed' on network error, gray 'Checking…' with spinner while fetching.",
      "trigger": "Dashboard.tsx: checkForUpdates() called once on mount via useEffect."
    },
    "v1_5_0_sidebar_and_telemetry": {
      "description": "Sidebar UX polish, unified sidebar filters for Overview, weather modal fix, map replay telemetry overlay.",
      "collapsible_sections": "Dashboard.tsx: Collapsible Import section (default expanded) moved below Flights/Overview toggle. FlightList.tsx: Collapsible Filters section (default collapsed). Both persisted to localStorage with 'click to expand' hints.",
      "duration_filter": "FlightList.tsx: Dual-thumb duration range slider with custom CSS (dual-range-wrap in index.css). Filters by flight duration in minutes.",
      "overview_filter_unification": "Overview.tsx: Removed all local filter UI (date picker, drone/battery dropdowns, CalendarIcon). Now reads sidebarFilteredFlightIds from Zustand store. flightStore.ts: Added sidebarFilteredFlightIds Set<number> and setSidebarFilteredFlightIds action. FlightList.tsx syncs filtered IDs via useEffect.",
      "weather_modal_fix": "WeatherModal.tsx: Rendered via createPortal to document.body (escapes parent stacking contexts). Adds modal-open class to body for scrollbar suppression.",
      "replay_telemetry_overlay": "FlightMap.tsx: New telemetry prop from Dashboard. replayTelemetry memo interpolates all telemetry fields at replay position. Fixed overlay (top-right, map-overlay style) shows height, speed, distance, battery (color-coded), voltage, temp, satellites, pitch/roll/yaw, and lat/lng. Hover tooltip paused during replay.",
      "telemetry_toggle_rename": "FlightMap.tsx: Toggle label renamed from 'Tooltip' to 'Telemetry'."
    },
    "map_area_filter_and_import_ux": {
      "description": "Overview map area filter for geographic filtering, import section auto-collapse, and UI polish.",
      "map_area_filter": "FlightList.tsx: New 'Overview map area filter' toggle in sidebar filters. When enabled, filters flights to only those with home coordinates visible on the overview map. FlightClusterMap.tsx: Tracks map bounds via onMoveEnd/onLoad handlers, passes bounds to store. Filter integrated into filteredFlights useMemo with bounds check.",
      "map_visual_feedback": "FlightClusterMap.tsx: When filter active, map card shows green glow border (ring-2 ring-emerald-500/40 shadow) and title changes to 'Flight Locations — Global filter active' in emerald. mapAreaFilterEnabled added to 'Filters — Active' header check.",
      "reset_zoom_button": "FlightClusterMap.tsx: 'Reset zoom' button in bottom-right corner. Uses allFlights prop (all flights, not just filtered) to fit bounds to entire dataset.",
      "import_auto_collapse": "Dashboard.tsx: Import section now auto-collapses when flights exist in database, auto-expands when empty. Uses new isFlightsInitialized store state to wait for DB load before determining collapsed state. No longer persisted to localStorage.",
      "store_changes": "flightStore.ts: Added isFlightsInitialized (true after first loadFlights), mapAreaFilterEnabled, mapVisibleBounds, setMapAreaFilterEnabled, setMapVisibleBounds."
    },
    "keyboard_navigation_and_ui_polish": {
      "description": "Keyboard shortcuts for accessibility, arrow key dropdown navigation, filter UI improvements, and auto-clear selection when filtered out.",
      "keyboard_shortcuts": "FlightList.tsx: Up/Down arrow keys navigate flight list (visual preview only). Enter key confirms and loads the selected flight. Scroll-into-view on navigation. SettingsModal.tsx and WeatherModal.tsx: Escape key closes modal (SettingsModal respects isBusy state).",
      "dropdown_arrow_keys": "Select.tsx: Added highlightedIndex state, ArrowUp/Down navigate options, Enter selects, Escape closes, mouse hover updates highlight. Removed duplicate onKeyDown handler that caused double-skip bug. FlightList.tsx: Sort dropdown, export dropdown, and tag dropdown all support arrow key navigation with highlighted state and Enter to confirm.",
      "filter_layout": "FlightList.tsx: Inline filter layout with consistent 52px label width column. Duration slider row restructured with flex layout. Duration value display centered. Tag dropdown overflow fixed with left-0 right-0 positioning and overflow-hidden.",
      "tag_sorting": "FlightList.tsx: Tags in dropdown sorted with selected tags first, then alphabetically.",
      "auto_clear_selection": "FlightList.tsx: Selection automatically cleared when currently selected flight is not in filtered results or when filters return no results. Prevents stale cached data from showing on map/charts."
    }
  },
  "behavior": {
    "theme": "Global theme (system/light/dark) applied to body, maps, and charts.",
    "units": "Metric/Imperial conversions for speed, height, distance.",
    "x_axis_ticks": "Shared time axis labels aligned across charts; labels rotated and overlap hidden."
  },
  "data_model": {
    "flight": {
      "fields": [
        "id",
        "fileName",
        "displayName",
        "startTime",
        "durationSecs",
        "totalDistance",
        "droneModel",
        "droneSerial",
        "aircraftName",
        "batterySerial",
        "tags"
      ]
    },
    "telemetry": {
      "fields": [
        "time",
        "latitude",
        "longitude",
        "height",
        "vpsHeight",
        "altitude",
        "speed",
        "velocityX",
        "velocityY",
        "velocityZ",
        "battery",
        "batteryVoltage",
        "batteryTemp",
        "pitch",
        "roll",
        "yaw",
        "rcSignal",
        "rcUplink",
        "rcDownlink",
        "satellites",
        "distanceToHome"
      ]
    }
  },
  "database": {
    "path": "~/.local/share/com.dji-logviewer.app/flights.db (desktop) or /data/dji-logviewer/flights.db (Docker)",
    "tables": {
      "flights": [
        "id",
        "file_name",
        "display_name",
        "file_hash",
        "drone_model",
        "drone_serial",
        "aircraft_name",
        "battery_serial",
        "start_time",
        "end_time",
        "duration_secs",
        "total_distance",
        "max_altitude",
        "max_speed",
        "home_lat",
        "home_lon",
        "point_count",
        "imported_at",
        "notes"
      ],
      "telemetry": [
        "flight_id",
        "timestamp_ms",
        "latitude",
        "longitude",
        "altitude",
        "height",
        "vps_height",
        "altitude_abs",
        "speed",
        "velocity_x",
        "velocity_y",
        "velocity_z",
        "pitch",
        "roll",
        "yaw",
        "gimbal_pitch",
        "gimbal_roll",
        "gimbal_yaw",
        "battery_percent",
        "battery_voltage",
        "battery_current",
        "battery_temp",
        "flight_mode",
        "gps_signal",
        "satellites",
        "rc_signal",
        "rc_uplink",
        "rc_downlink"
      ],
      "flight_tags": [
        "flight_id",
        "tag",
        "tag_type"
      ],
      "keychains": [
        "serial_number",
        "encryption_key",
        "fetched_at"
      ]
    },
    "notes": [
      "Telemetry table column order is enforced; if mismatched it rebuilds automatically.",
      "Bulk inserts use DuckDB Appender matching the exact column order above.",
      "Downsampling occurs when telemetry points exceed ~5000 (1s buckets).",
      "Map track altitude uses COALESCE(height, vps_height, altitude) for relative 3D paths.",
      "App data dir structure: flights.db + keychains/.",
      "Failed telemetry inserts trigger automatic flight metadata cleanup.",
      "flight_tags table stores per-flight tags with tag_type (auto/manual). Included in backup/restore. Migration adds tag_type column if missing.",
      "Smart tags config (enabled/disabled) stored in config.json alongside API key."
    ]
  },
  "api_endpoints": {
    "note": "Web mode only (Axum server). All endpoints mirror Tauri commands.",
    "routes": [
      "POST   /api/import            - Upload flight log (multipart)",
      "GET    /api/flights            - List all flights",
      "GET    /api/flight_data        - Get telemetry (query: flight_id, max_points)",
      "GET    /api/overview           - Overview statistics",
      "DELETE /api/flights/delete     - Delete flight (query: flight_id)",
      "DELETE /api/flights/delete_all - Delete all flights",
      "PUT    /api/flights/name       - Rename flight (JSON: flight_id, display_name)",
      "GET    /api/has_api_key        - Check API key configured",
      "POST   /api/set_api_key        - Set API key (JSON: api_key)",
      "GET    /api/app_data_dir       - Data directory path",
      "GET    /api/app_log_dir        - Log directory path",
      "POST   /api/flights/tags/add   - Add a manual tag to a flight (JSON: flight_id, tag)",
      "POST   /api/flights/tags/remove - Remove a tag from a flight (JSON: flight_id, tag)",
      "GET    /api/tags                - Get all unique tags across all flights",
      "GET    /api/settings/smart_tags - Check if smart tags are enabled",
      "POST   /api/settings/smart_tags - Set smart tags enabled (JSON: enabled)",
      "POST   /api/regenerate_smart_tags - Regenerate auto tags for all flights",
      "GET    /api/backup             - Download compressed database backup (tar.gz of Parquet files)",
      "POST   /api/backup/restore     - Upload and restore a backup file (multipart)"
    ]
  },
  "parser": {
    "version": "dji-log-parser v0.5.7",
    "inputs": "DJI .dat/.txt logs",
    "outputs": [
      "Flight metadata (aircraft name, drone model/serial, battery serial, start/end, duration)",
      "Telemetry arrays (time, position, orientation, battery, RC, GPS)"
    ],
    "notes": [
      "Height uses OSD height when available; VPS height stored separately.",
      "Altitude fallback uses altitude if height is missing.",
      "Display name defaults to filename; can be edited in UI.",
      "Corrupt frames (non-finite lat/lon/alt/speed) are skipped with logging.",
      "GPS coordinates outside +/-90 lat / +/-180 lon are treated as out-of-range and excluded.",
      "Altitude/height values >10km and speed >100 m/s are clamped to None.",
      "V13+ logs require keychain decryption; API key fetched from config or default.",
      "File deduplication via SHA256 hash prevents re-importing the same log.",
      "Parsing runs in spawn_blocking with catch_unwind and 40s timeout for crash safety.",
      "Smart tags generated from FlightStats: night detection (local hour via lon-based TZ offset), speed, battery, altitude, distance, duration thresholds.",
      "Offline reverse geocoding via reverse_geocoder crate (bundled GeoNames dataset ~15MB). Returns city name, country (from CC lookup table), and continent."
    ]
  },
  "commands": {
    "frontend": [
      "npm run dev            - Tauri frontend dev server",
      "npm run dev:web        - Web mode dev server (with /api proxy)",
      "npm run build          - Tauri frontend build",
      "npm run build:web      - Web mode frontend build",
      "npm run preview"
    ],
    "tauri": [
      "npm run tauri          - Full Tauri dev mode",
      "npm run tauri:nowatch  - Tauri dev without file watching"
    ],
    "docker": [
      "docker compose up -d                                    - Run with pre-built GHCR image",
      "docker compose -f docker-compose-build.yml up -d          - Build from source and run",
      "docker compose -f docker-compose-build.yml up --build -d  - Force rebuild from source"
    ]
  },
  "ci_cd": {
    "build_yml": {
      "trigger": "on release published",
      "platforms": ["ubuntu-latest", "windows-latest", "macos-latest"],
      "action": "tauri-apps/tauri-action@v0",
      "artifacts": "Desktop binaries uploaded to GitHub Release"
    },
    "docker_yml": {
      "trigger": "on release published + manual dispatch",
      "registry": "ghcr.io",
      "image": "ghcr.io/arpanghosh8453/dji-logbook",
      "tags": "semver (e.g. 1.2.3, 1.2) + latest (auto) on release; custom tag on manual dispatch"
    }
  },
  "ui": {
    "themes": "CSS variables in src/index.css; body classes theme-light/theme-dark. Light mode uses !important overrides.",
    "filters": "Flight list uses date range popover (react-day-picker), drone and battery selects (searchable via type-to-filter), dual-thumb duration slider, and multi-select tag filter. Filter inversion button (circular arrows) individually negates each active filter (AND logic: NOT A AND NOT B). Collapsible filter/import panels persisted to localStorage. Overview shares sidebar filters via store. Selection auto-clears when selected flight is no longer in filtered results.",
    "keyboard_navigation": "FlightList: Up/Down arrows browse flights (preview highlight), Enter selects and loads. All modals close on Escape. Select/sort/export/tag dropdowns support arrow key navigation with highlighted index.",
    "flight_list": "Simple compact list with always-visible rename (pencil icon, sky-400) and delete (trash icon, red-400) icons. Subtitle shows date . duration . distance.",
    "charts": "ECharts with synced zoom; global drag-to-zoom toggle + reset zoom buttons; tooltip header uses pill capsules. Theme-aware base config. Hidden per-chart toolbox enables selection highlight for drag-to-zoom.",
    "map": "MapLibre terrain with deck.gl overlay. Spline-smoothed color-by gradient path, shadow layer, start/end/home markers, hover tooltip. Replay telemetry overlay with live-interpolated data during playback. RC stick input overlay with progressive-fill bars and theme-aware styling (cyan on dark, dark slate on light).",
    "loading": "Spinner uses border-sky-400 for both-mode visibility."
  },
  "known_issues": [
    "If import fails with column order mismatch, telemetry table rebuild should correct it.",
    "Node engine warnings may appear for some transient packages; app still runs.",
    "Older DJI logs (pre-2020) may produce garbage telemetry values; parser validation filters these out.",
    "macOS binaries are unsigned (no Apple Developer account); users need xattr -d com.apple.quarantine workaround."
  ],
  "notes": {
    "api_key": "Stored locally in config.json; never sent except to DJI API.",
    "db_location_desktop": "App data dir under ~/.local/share/com.dji-logviewer.app (flights.db + keychains/)",
    "db_location_docker": "/data/dji-logviewer (persistent volume)",
    "log_location": "Log files under ~/.local/share/com.dji-logviewer.app/logs/ (desktop) or stdout (Docker)",
    "git": {
      "branch": "main"
    }
  }
}
